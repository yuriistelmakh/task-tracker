@using TaskTracker.Domain.Enums
@using TaskTracker.WebApp.Models
<MudDialog TitleClass="pa-0"
           ContentClass="pa-4">
    <DialogContent>
        <MudStack Row=true
                  AlignItems=@AlignItems.Center>
            <MudText Typo=@Typo.h6>
                <bold>Board settings</bold>
            </MudText>

            <MudSpacer />

            <MudIconButton Icon=@Icons.Material.Filled.Close
                           @onclick="OnCloseClicked" />
        </MudStack>

        <MudTabs Elevation=0
                 Rounded=true
                 ApplyEffectsToContainer=true
                 SliderAnimation=true>
            <MudTabPanel Text="General"
                         Style="text-transform: none !important;"
                         Class="py-2">
                <MudStack Spacing=0
                          Style="width: 50%">
                    <MudText>Board title</MudText>
                    <MudForm @ref=@_titleForm>
                        <MudTextField @bind-Value=@_title
                                      Variant=@Variant.Outlined
                                      Margin=@Margin.Dense
                                      Placeholder="For example: Marketing campaign"
                                      Counter=50
                                      MaxLength=50
                                      Immediate=true
                                      Required=true>

                        </MudTextField>
                    </MudForm>
                </MudStack>

                <MudText>Board description</MudText>
                <MudTextField @bind-Value=@_description
                              Variant=@Variant.Outlined
                              Margin=@Margin.Dense
                              Placeholder="Enter board description..."
                              MaxLength=500
                              Immediate=true
                              Lines=3>

                </MudTextField>

                <MudContainer Class="d-flex justify-end pa-0 mt-2">
                    <MudButton>Cancel</MudButton>

                    <MudButton Variant=@Variant.Filled
                               Color=@Color.Primary
                               Class="ml-2"
                               OnClick=@SaveGeneralChanges
                               IsDefault=true>
                        Save
                    </MudButton>
                </MudContainer>
            </MudTabPanel>

            <MudTabPanel Text="Appearance"
                         Style="text-transform: none !important;"
                         Class="py-2">

                <MudText Class="py-2">Board background</MudText>

                <MudGrid Spacing=2>
                    @foreach (var color in _backgroundColorOptions)
                    {
                        <MudItem xs=2>
                            <MudPaper Class="d-flex align-center justify-center py-8 cursor-pointer"
                                      Elevation=2
                                      Style="@($"background-color:{color}; box-sizing: border-box;" +
                                    (color == _selectedColor ? "border: 3px solid maroon" : "border: 3px solid transparent"))"
                                      @onclick=@(() => OnColorClicked(color))>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>

                <MudContainer Class="d-flex justify-end pa-0 mt-2">
                    <MudButton Variant=@Variant.Filled
                               Color=@Color.Primary
                               Class="ml-2"
                               OnClick=@SaveAppearanceChanges
                               IsDefault=true>
                        Save
                    </MudButton>
                </MudContainer>
            </MudTabPanel>

            <MudTabPanel Text=@($"Members ({_totalMembersCount})")
                         Style="text-transform: none !important;"
                         Class="py-2">
                <MudGrid Spacing=3>
                    <MudItem xs=8>
                        <MudInput T=string
                                  Adornment=@Adornment.Start
                                  AdornmentIcon=@Icons.Material.Filled.Search
                                  Variant=@Variant.Outlined
                                  Margin=@Margin.Dense
                                  Style="width: 100%"
                                  Placeholder="Search members..." />

                        <MudStack Class="pt-2"
                                  Style="min-height: 250px">
                            @foreach (var member in _members)
                            {
                                <MudPaper Class="pa-2"
                                          Elevation=0
                                          Style="border: 1px solid var(--mud-palette-secondary)">

                                    <MudGrid Spacing=2>

                                        <MudItem xs=6>
                                            <MudStack Row=true
                                                      AlignItems=@AlignItems.Center>
                                                <MudIcon Icon=@Icons.Material.Filled.AccountCircle
                                                         Size=@Size.Large />
                                                <MudStack Spacing=0>
                                                    <MudStack Row=true
                                                              Spacing=1
                                                              AlignItems=@AlignItems.Center>
                                                        <MudText>@member.DisplayName</MudText>
                                                        @if (member.Role == BoardRole.Owner)
                                                        {
                                                            <MudTooltip Text="Owner"
                                                                        Inline=true
                                                                        Arrow=true
                                                                        Placement=@Placement.Top>
                                                                <MudIcon Icon=@Icons.Material.Filled.Star
                                                                         Size=@Size.Small />
                                                            </MudTooltip>
                                                        }
                                                    </MudStack>
                                                    <MudText Typo=@Typo.subtitle2 Color=@Color.Primary>@($"@{member.Tag}")</MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudItem>

                                        <MudItem xs=6>
                                            @if (_currentUserRole > BoardRole.Member)
                                            {
                                                <MudSelect T=@BoardRole
                                                           Margin=@Margin.Dense
                                                           Variant=@Variant.Outlined
                                                           FullWidth=true
                                                           Value=@member.Role
                                                           ValueChanged=@((BoardRole newRole) => OnRoleChange(member, newRole))
                                                           Disabled=@(member.Role == BoardRole.Owner && member.Id != _currentUserId)>
                                                    @if (_currentUserRole == BoardRole.Owner)
                                                    {
                                                        <MudSelectItem Value=@BoardRole.Owner>
                                                            <MudText>Owner</MudText>
                                                            <MudText Typo=@Typo.caption
                                                                     Style="line-height: 5px !important">
                                                                Has full control over the board including its deletion
                                                            </MudText>
                                                        </MudSelectItem>
                                                    }

                                                    <MudSelectItem Value=@BoardRole.Admin>
                                                        <MudText>Administrator</MudText>
                                                        <MudText Typo=@Typo.caption>
                                                            Can manage board settings and members
                                                        </MudText>
                                                    </MudSelectItem>

                                                    <MudSelectItem Value=@BoardRole.Member>
                                                        <MudText>Member</MudText>
                                                        <MudText Typo=@Typo.caption>
                                                            Can create, edit and delete tasks
                                                        </MudText>
                                                    </MudSelectItem>

                                                    <MudSelectItem Value=@BoardRole.Visitor>
                                                        <MudText>Visitor</MudText>
                                                        <MudText Typo=@Typo.caption>
                                                            Can only view the board
                                                        </MudText>
                                                    </MudSelectItem>
                                                </MudSelect>
                                            }
                                            else
                                            {
                                                <MudContainer Class="d-flex justify-end align-center pa-0 pr-2"
                                                              Style="height: 100%">
                                                    <MudText>@member.Role</MudText>
                                                </MudContainer>
                                            }
                                        </MudItem>

                                    </MudGrid>
                                </MudPaper>
                            }

                            @if (_totalMembersPages > 1)
                            {
                                <MudContainer Class="pa-0 d-flex justify-end">
                                    <MudPagination Count=@_totalMembersPages
                                                   Selected=@_currentMembersPage
                                                   SelectedChanged=@OnPageChanged />
                                </MudContainer>
                            }
                        </MudStack>
                    </MudItem>

                    <MudItem xs=4
                             Class="pr-1">
                        <MudCard Class="pa-2"
                                 Elevation=3>
                            <MudStack Row=true
                                      Spacing=1>
                                <MudIcon Icon=@Icons.Material.Filled.PersonAdd />
                                <MudText>Invite a user</MudText>
                            </MudStack>

                            <MudAutocomplete T=@UserSummaryModel
                                             @bind-Value=@_invitationUserSearch
                                             DebounceInterval=500
                                             SearchFunc=@PerformSearch
                                             FullWidth=true
                                             Variant=@Variant.Outlined
                                             Margin=@Margin.Dense
                                             Adornment=@Adornment.None
                                             ToStringFunc=@(p => p is null ? null : p.DisplayName)
                                             Class="mt-2"
                                             Placeholder="Find by name or tag...">

                                <ItemTemplate Context="e">
                                    <MudStack Row=true
                                              AlignItems=@AlignItems.Center
                                              Spacing=2>
                                        <MudIcon Icon=@Icons.Material.Filled.AccountCircle />
                                        <MudStack Spacing=0>
                                            <MudText>@e.DisplayName</MudText>
                                            <MudText Typo=@Typo.caption>@($"@{e.Tag}")</MudText>
                                        </MudStack>
                                    </MudStack>
                                </ItemTemplate>
                            </MudAutocomplete>

                            <MudSelect T=@BoardRole
                                       @bind-Value=@_selectedInviteRole
                                       Variant=@Variant.Outlined
                                       Margin=@Margin.Dense>
                                <MudSelectItem T=@BoardRole
                                               Value=@BoardRole.Admin>
                                    Administrator
                                </MudSelectItem>
                                <MudSelectItem T=@BoardRole
                                               Value=@BoardRole.Member>
                                    Member
                                </MudSelectItem>
                                <MudSelectItem T=@BoardRole
                                               Value=@BoardRole.Visitor>
                                    Visitor
                                </MudSelectItem>
                            </MudSelect>

                            <MudButton FullWidth=true
                                       Variant=@Variant.Filled
                                       Color=@Color.Primary
                                       OnClick=@SendInvitations
                                       Disabled=@(_invitationUserSearch is null)
                                       Class="mt-2">
                                <MudIcon Icon=@Icons.Material.Filled.PersonAdd
                                         Class="mr-1" />
                                Send invitation
                            </MudButton>
                        </MudCard>

                        <MudCard Class="pa-3 mt-2"
                                 Elevation=3>
                            <MudStack Row=true
                                      Spacing=1>
                                <MudIcon Icon=@Icons.Material.Filled.ShowChart/>
                                <MudText>Statistics</MudText>
                            </MudStack>

                            <MudText>@($"Owners: {_ownersCount}")</MudText>
                            <MudText>@($"Admministrators: {_adminsCount}")</MudText>
                            <MudText>@($"Members: {_membersCount}")</MudText>
                            <MudText>@($"Visitors: {_visitorsCount}")</MudText>
                            
                        </MudCard>
                    </MudItem>
                </MudGrid>
                <MudContainer Class="d-flex justify-end pa-0">
                    <MudButton Variant=@Variant.Filled
                               Color=@Color.Primary
                               @onclick=@OnCloseClicked>
                        Done
                    </MudButton>
                </MudContainer>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
</MudDialog>