@using TaskTracker.Domain.Enums
@using TaskTracker.WebApp.Models.Users

<MudDialog TitleClass="pa-0"
           ContentClass="pa-4">
    <DialogContent>
        <MudStack Row=true
                  AlignItems=@AlignItems.Center>
            <MudText Typo=@Typo.h6>
                <bold>Board settings</bold>
            </MudText>

            <MudSpacer />

            <MudIconButton Icon=@Icons.Material.Filled.Close
                           @onclick="OnCloseClicked" />
        </MudStack>

        <MudTabs Elevation=0
                 Rounded=true
                 ApplyEffectsToContainer=true
                 SliderAnimation=true>
            <MudTabPanel Text="General"
                         Style="text-transform: none !important;"
                         Class="py-2">
                <MudStack Spacing=0
                          Style="width: 50%">
                    <MudText>Board title</MudText>
                    <MudForm @ref=@_titleForm>
                        <MudTextField @bind-Value=@_title
                                      Variant=@Variant.Outlined
                                      Margin=@Margin.Dense
                                      Placeholder="For example: Marketing campaign"
                                      Counter=50
                                      MaxLength=50
                                      Immediate=true
                                      Required=true>

                        </MudTextField>
                    </MudForm>
                </MudStack>

                <MudText>Board description</MudText>
                <MudTextField @bind-Value=@_description
                              Variant=@Variant.Outlined
                              Margin=@Margin.Dense
                              Placeholder="Enter board description..."
                              MaxLength=500
                              Immediate=true
                              Lines=3>

                </MudTextField>

                @if (_currentUserRole == BoardRole.Owner)
                {
                    <MudButton Color=@Color.Error
                               Variant=@Variant.Filled
                               Class="my-2"
                               @onclick=OnDeleteBoardClicked>
                        <MudStack Row=true
                                  Spacing=1>
                            <MudIcon Icon=@Icons.Material.Filled.Delete />
                            Delete board
                        </MudStack>
                    </MudButton>
                }

                <MudContainer Class="d-flex justify-end pa-0 mt-2">
                    <MudButton>Cancel</MudButton>

                    <MudButton Variant=@Variant.Filled
                               Color=@Color.Primary
                               Class="ml-2"
                               OnClick=@SaveGeneralChanges
                               IsDefault=true>
                        Save
                    </MudButton>
                </MudContainer>
            </MudTabPanel>

            <MudTabPanel Text="Appearance"
                         Style="text-transform: none !important;"
                         Class="py-2">

                <MudText Class="py-2">Board background</MudText>

                <MudGrid Spacing=2>
                    @foreach (var color in _backgroundColorOptions)
                    {
                        <MudItem xs=2>
                            <MudPaper Class="d-flex align-center justify-center py-8 cursor-pointer"
                                      Elevation=2
                                      Style="@($"background-color:{color}; box-sizing: border-box;" +
                                                                          (color == _selectedColor ? "border: 3px solid maroon" : "border: 3px solid transparent"))"
                                  @onclick=@(() => OnColorClicked(color))>
                        </MudPaper>
                    </MudItem>
                                        }
                </MudGrid>

                <MudContainer Class="d-flex justify-end pa-0 mt-2">
                    <MudButton Variant=@Variant.Filled
                               Color=@Color.Primary
                               Class="ml-2"
                               OnClick=@SaveAppearanceChanges
                               IsDefault=true>
                        Save
                    </MudButton>
                </MudContainer>
            </MudTabPanel>

            <MudTabPanel Text="Members"
                         Style="text-transform: none !important;"
                         Class="py-2">
                <MudGrid Spacing=3>
                    <MudItem xs=8>
                        <MudTextField T=string
                                      Adornment=@Adornment.Start
                                      AdornmentIcon=@Icons.Material.Filled.Search
                                      Variant=@Variant.Outlined
                                      DebounceInterval=500
                                      ValueChanged=PerformGlobalSearch
                                      Margin=@Margin.Dense
                                      Style="width: 100%"
                                      Placeholder="Search members..." />

                        <MudStack Class="pt-2"
                                  Style="min-height: 250px">
                            @foreach (var member in _members)
                            {
                                var isKickAllowed = _currentUserRole >= BoardRole.Admin && member.Role != BoardRole.Owner;
                                    <MudPaper Class=@($"pa-2 member-card {(isKickAllowed ? "is-kick-allowed" : string.Empty)}")
                                              Elevation=0
                                              Style="border: 1px solid var(--mud-palette-secondary); position: relative; overflow: hidden;">

                                        <MudStack Row=true
                                                  AlignItems=@AlignItems.Center
                                                  Justify=@Justify.SpaceBetween>
                                            <MudStack Row=true
                                                      AlignItems=@AlignItems.Center
                                                      Spacing=2>
                                                @if (!string.IsNullOrEmpty(member.AvatarUrl))
                                                {
                                                    <MudAvatar Size=@Size.Medium>
                                                        <MudImage Src=@member.AvatarUrl
                                                                  Alt=@member.DisplayName
                                                                  ObjectFit=@ObjectFit.Cover />
                                                    </MudAvatar>
                                                }
                                                else
                                                {
                                                    <MudIcon Icon=@Icons.Material.Filled.AccountCircle
                                                             Size=@Size.Large />
                                                }
                                                <MudStack Spacing=0>
                                                    <MudStack Row=true
                                                              Spacing=1
                                                              AlignItems=@AlignItems.Center>
                                                        <MudText>@member.DisplayName</MudText>
                                                        @if (member.Role == BoardRole.Owner)
                                                        {
                                                            <MudTooltip Text="Owner"
                                                                        Inline=true
                                                                        Arrow=true
                                                                        Placement=@Placement.Top>
                                                                <MudIcon Icon=@Icons.Material.Filled.Star
                                                                         Size=@Size.Small />
                                                            </MudTooltip>
                                                        }
                                                    </MudStack>
                                                    <MudText Typo=@Typo.subtitle2 Color=@Color.Primary>@($"@{member.Tag}")</MudText>
                                                </MudStack>
                                            </MudStack>

                                            @if (_currentUserRole >= BoardRole.Admin)
                                            {
                                                <MudStack Row=true
                                                          Spacing=1
                                                          AlignItems=@AlignItems.Center>
                                                    <MudSelect T=@BoardRole
                                                               Margin=@Margin.Dense
                                                               Variant=@Variant.Outlined
                                                               Style="width: 150px;"
                                                               Value=@member.Role
                                                               ValueChanged=@((BoardRole newRole) => OnRoleChange(member, newRole))
                                                               Disabled=@(member.Role == BoardRole.Owner && member.Id != _currentUserId)>
                                                        @if (_currentUserRole == BoardRole.Owner)
                                                        {
                                                            <MudSelectItem Value=@BoardRole.Owner>Owner</MudSelectItem>
                                                        }
                                                        <MudSelectItem Value=@BoardRole.Admin>Admin</MudSelectItem>
                                                        <MudSelectItem Value=@BoardRole.Member>Member</MudSelectItem>
                                                        <MudSelectItem Value=@BoardRole.Visitor>Visitor</MudSelectItem>
                                                    </MudSelect>

                                                    <MudIconButton Icon=@Icons.Material.Filled.PersonRemove
                                                                   Color=@Color.Error
                                                                   Size=@Size.Small
                                                                   Disabled=@(!isKickAllowed && member.Id != _currentUserId)
                                                                   OnClick=@(() => OnMemberKickClicked(member)) />

                                                </MudStack>
                                            }
                                            else
                                            {
                                                <MudText>@member.Role</MudText>
                                            }
                                        </MudStack>
                                    </MudPaper>
                            }

                            @if (_totalMembersPages > 1)
                            {
                                <MudContainer Class="pa-0 d-flex justify-end">
                                    <MudPagination Count=@_totalMembersPages
                                                   Selected=@_currentMembersPage
                                                   SelectedChanged=@OnPageChanged />
                                </MudContainer>
                            }
                        </MudStack>
                    </MudItem>

                    <MudItem xs=4
                             Class="pr-1">
                        <MudCard Class="pa-2"
                                 Elevation=3>
                            <MudStack Row=true
                                      Spacing=1>
                                <MudIcon Icon=@Icons.Material.Filled.PersonAdd />
                                <MudText>Invite a user</MudText>
                            </MudStack>

                            <MudAutocomplete T=@UserSummaryModel
                                             @bind-Value=@_invitationUserSearch
                                             DebounceInterval=500
                                             SearchFunc=@PerformAutocompleteSearch
                                             FullWidth=true
                                             Variant=@Variant.Outlined
                                             Margin=@Margin.Dense
                                             Adornment=@Adornment.None
                                             ToStringFunc=@(p => p is null ? null : p.DisplayName)
                                             Class="mt-2"
                                             Placeholder="Find by name or tag...">

                                <ItemTemplate Context="e">
                                    <MudStack Row=true
                                              AlignItems=@AlignItems.Center
                                              Spacing=2>
                                        @if (!string.IsNullOrEmpty(e.AvatarUrl))
                                        {
                                            <MudAvatar Size=@Size.Medium>
                                                <MudImage Src=@e.AvatarUrl
                                                          Alt=@e.DisplayName
                                                          ObjectFit=@ObjectFit.Cover />
                                            </MudAvatar>
                                        }
                                        else
                                        {
                                            <MudIcon Icon=@Icons.Material.Filled.AccountCircle
                                                     Size=@Size.Large />
                                        }
                                        <MudStack Spacing=0>
                                            <MudText>@e.DisplayName</MudText>
                                            <MudText Typo=@Typo.caption>@($"@{e.Tag}")</MudText>
                                        </MudStack>
                                    </MudStack>
                                </ItemTemplate>
                            </MudAutocomplete>

                            <MudSelect T=@BoardRole
                                       @bind-Value=@_selectedInviteRole
                                       Variant=@Variant.Outlined
                                       Margin=@Margin.Dense>
                                <MudSelectItem T=@BoardRole
                                               Value=@BoardRole.Admin>
                                    Administrator
                                </MudSelectItem>
                                <MudSelectItem T=@BoardRole
                                               Value=@BoardRole.Member>
                                    Member
                                </MudSelectItem>
                                <MudSelectItem T=@BoardRole
                                               Value=@BoardRole.Visitor>
                                    Visitor
                                </MudSelectItem>
                            </MudSelect>

                            <MudButton FullWidth=true
                                       Variant=@Variant.Filled
                                       Color=@Color.Primary
                                       OnClick=@SendInvitations
                                       Disabled=@(_invitationUserSearch is null)
                                       Class="mt-2">
                                <MudIcon Icon=@Icons.Material.Filled.PersonAdd
                                         Class="mr-1" />
                                Send invitation
                            </MudButton>
                        </MudCard>

                        <MudCard Class="pa-3 mt-2"
                                 Elevation=3>
                            <MudStack Row=true
                                      Spacing=1>
                                <MudIcon Icon=@Icons.Material.Filled.ShowChart />
                                <MudText>Statistics</MudText>
                            </MudStack>

                            <MudText>@($"Owners: {_ownersCount}")</MudText>
                            <MudText>@($"Administrators: {_adminsCount}")</MudText>
                            <MudText>@($"Members: {_membersCount}")</MudText>
                            <MudText>@($"Visitors: {_visitorsCount}")</MudText>

                        </MudCard>
                    </MudItem>
                </MudGrid>
                <MudContainer Class="d-flex justify-end pa-0 pt-2">
                    <MudButton Variant=@Variant.Filled
                               Color=@Color.Primary
                               @onclick=@OnCloseClicked>
                        Done
                    </MudButton>
                </MudContainer>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
</MudDialog>