@page "/boards/{BoardId:int}"
@using TaskTracker.WebApp.Components.Layout.Headers
@using TaskTracker.WebApp.Components.Pages.Auth
@using TaskTracker.WebApp.Models
@rendermode InteractiveServer

<AuthGuard>
    <Header SearchPlaceholder="Search tasks...">
        <LeftContent>
            <MudIconButton Icon=@Icons.Material.Filled.ChevronLeft
            Size=@Size.Large
            Color=@Color.Inherit
            Edge=@Edge.Start
            Class="pa-1 mr-1"
            Href="/" />
        </LeftContent>
    </Header>

    <div>
        <MudMainContent Class="mt-8 mx-8"
        Style="height: calc(100vh - var(--mud-appbar-height));">
            <MudDropContainer T=@TaskSummaryModel
            Items=@_allTasks
            Class="d-flex flex-nowrap gap-4"
            @ref=@_dropContainer
            ItemsSelector=@((item,dropzone) => item.ColumnId.ToString() == dropzone)
            ItemDropped=@TaskDropped>
                <ChildContent>
                    @foreach (var column in _columns)
                    {
                        <MudItem>
                            <MudPaper Class="d-flex flex-column mud-width-full pt-2 mb-4"
                            MinHeight="75px"
                            Width="325px">

                                <MudContainer Class="px-4 py-1 d-flex">
                                    @if (column.IsEditing)
                                    {
                                        <MudTextField @bind-Value=@column.Title
                                                      Immediate=true
                                                      Variant=@Variant.Text
                                                      FullWidth=true
                                                      AutoFocus=true
                                                      MaxLength=50
                                                      Placeholder="Enter column title"
                                                      Style="font-size: 1.2rem"
                                                      @onkeydown=@((e) => HandleEditColumnEnter(e, column))>
                                        </MudTextField>

                                        <MudIconButton Class="pa-2 flex-shrink-0"
                                                       Icon=@Icons.Material.Filled.Close
                                                       Color=@Color.Error
                                                       @onclick=@(() => EditColumnClose(column))>
                                        </MudIconButton>
                                    }
                                    else
                                    {
                                        <MudText Typo=@Typo.h6
                                                 Class="flex-grow-1"
                                                 Style="word-break: break-word">
                                            @column.Title
                                        </MudText>

                                        <MudMenu Icon=@Icons.Material.Filled.MoreVert
                                                 Color=@Color.Primary
                                                 Size=@Size.Small
                                                 AnchorOrigin=@Origin.BottomCenter
                                                 TransformOrigin=@Origin.TopLeft>
                                            <MudMenuItem Icon=@Icons.Material.Filled.Edit
                                                         Class="px-2 py-1"
                                                         Style="white-space: nowrap;"
                                                         OnClick=@(() => OnEditColumnClick(column))>
                                                Change title
                                            </MudMenuItem>
                                            <MudMenuItem IconColor=@Color.Error
                                                         Icon=@Icons.Material.Filled.Delete
                                                         Style="color: var(--mud-palette-error)"
                                                         Class="px-2 py-1"
                                                         OnClick=@(() => OnDeleteColumnClick(column))>
                                                Delete
                                            </MudMenuItem>
                                        </MudMenu>
                                    }
                                </MudContainer>

                                <MudContainer Class="d-flex flex-column flex-grow-1 flex-shrink-1 pb-4 px-2">
                                    <MudDropZone T=@TaskSummaryModel
                                                 Identifier=@column.Id.ToString()
                                                 Class="flex-grow-1"
                                                 AllowReorder=true
                                                 Style="min-height: 10px;" />

                                    @if (column.IsAddTaskOpen)
                                    {
                                        <div>
                                            <MudPaper Class="task d-flex flex-column my-1 mud-theme-secondary cursor-pointer overflow-hidden"
                                                      Elevation=1>
                                                <div class="d-flex align-center py-1">
                                                    <MudTextField @bind-Value=@column.NewTaskTitle
                                                                  Immediate=true
                                                                  Variant=@Variant.Filled
                                                                  Class="task-add-field flex-grow-1"
                                                                  Style="word-break: break-word;"
                                                                  Lines=2
                                                                  MaxLength=200
                                                                  AutoFocus=true
                                                                  Placeholder="Enter a title"
                                                                  AutoGrow=true
                                                                  Margin=@Margin.None
                                                                  OnKeyDown=@(e => HandleAddTaskEnter(e, column))>
                                                    </MudTextField>

                                                    <MudIconButton Class="pa-2 flex-shrink-0"
                                                                   Icon=@Icons.Material.Filled.Check
                                                                   @onclick=@(() => AddNewTask(column))>
                                                    </MudIconButton>

                                                    <MudIconButton Class="pa-2 pr-3 flex-shrink-0"
                                                                   Icon=@Icons.Material.Filled.Close
                                                                   Color=@Color.Error
                                                                   @onclick=@(() => AddTaskClose(column))>
                                                    </MudIconButton>
                                                </div>
                                            </MudPaper>
                                        </div>
                                    }
                                </MudContainer>

                                <MudButton Class="pa-4 justify-start flex-shrink-0"
                                           FullWidth=true
                                           @onclick=@(() => OnAddTaskClick(column))>
                                    <MudIcon Icon=@Icons.Material.Filled.Add Class="mr-2" />
                                    <MudText>Add another card</MudText>
                                </MudButton>
                            </MudPaper>
                        </MudItem>
                    }

                    @if (_isAddColumnOpen)
                    {
                        <MudItem>
                            <MudPaper Class="d-flex flex-column justify-center mud-width-full"
                                      MinHeight="100px"
                                      MinWidth="375px">

                                <MudTextField @bind-Value=@_addColumnTitle
                                              Immediate=true
                                              Variant=@Variant.Outlined
                                              FullWidth=true
                                              Class="px-4 pt-4"
                                              AutoFocus=true
                                              MaxLength=50
                                              Placeholder="Enter column title"
                                              @onkeydown=@((e) => HandleAddColumnEnter(e))>
                                </MudTextField>

                                <MudStack Row=true Class="align-self-end px-2 py-1">
                                    <MudIconButton Class="pa-2"
                                                   Icon=@Icons.Material.Filled.Check
                                                   @onclick=@(() => AddNewColumn())>
                                    </MudIconButton>

                                    <MudIconButton Class="pa-2"
                                                   Icon=@Icons.Material.Filled.Close
                                                   Color=@Color.Error
                                                   @onclick=@(() => AddNewColumnClose())>
                                    </MudIconButton>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                    else
                    {
                        <MudItem>
                            <MudPaper Class="d-flex align-center justify-center mud-width-full cursor-pointer mr-4"
                                      Height="525px"
                                      Width="375px"
                                      Style="border: 2px dashed var(--mud-palette-secondary); background-color: transparent;"
                                      @onclick=OnAddColumnClick>
                                <MudStack AlignItems=@AlignItems.Center
                                          Spacing=2>

                                    <MudIcon Icon=@Icons.Material.Filled.Add
                                             Size=@Size.Large
                                             Color=@Color.Secondary />

                                    <MudText Typo=@Typo.h6
                                             Color=@Color.Secondary>
                                        Add another column
                                    </MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </ChildContent>
                <ItemRenderer Context="task">
                    <div>
                        <MudPaper Class="task d-flex flex-column my-1 mud-theme-secondary cursor-pointer overflow-hidden"
                                  Elevation=1
                                  @onclick=@(() => OnTaskClicked(task.Id))>
                            <div style="height: 4px; width: 100%; background-color: @GetColorForPriority(task.Priority);"></div>

                            <div class="d-flex align-center py-2">
                                <MudText Class="px-4 flex-grow-1"
                                         Style="@((task.IsComplete ? "text-decoration: line-through;" : "") + " word-break: break-word;")">
                                    @task.Title
                                </MudText>

                                <MudCheckBox T="bool"
                                             ValueChanged="@(() => OnCheckedChange(task))"
                                             Value="@task.IsComplete"
                                             Class="flex-shrink-0" />
                            </div>
                        </MudPaper>
                    </div>
                </ItemRenderer>

            </MudDropContainer>
        </MudMainContent>
    </div>
</AuthGuard>
