@page "/boards/{BoardId:int}"
@using TaskTracker.Domain.Enums
@using TaskTracker.WebApp.Models
@using TaskTracker.WebApp.Models.Tasks
@using TaskTracker.WebApp.Components.Layout.Headers
@using TaskTracker.WebApp.Components.Pages.Auth
@rendermode InteractiveServer

<AuthGuard>
    <Header>
        <LeftContent>
            <MudIconButton Icon=@Icons.Material.Filled.ChevronLeft
                           Size=@Size.Large
                           Color=@Color.Inherit
                           Edge=@Edge.Start
                           Class="pa-1 mr-1"
                           Href="/" />
        </LeftContent>

        <MiddleContent>
            <MudDivider Vertical=true
                        Class="ma-4"
                        Style="height: 70%" />

            <MudText Typo=@Typo.h6>
                @_boardTitle
            </MudText>

            <MudAutocomplete Value=@_taskSearchInput
                          T=@TaskSummaryModel
                          ValueChanged=@OnTaskSelectedFromSearch
                          Placeholder="Search tasks..."
                          Variant=@Variant.Outlined
                          SearchFunc=@PerformTaskSearch
                          Style="width: 500px"
                          ToStringFunc=@(t => t is null ? null : t.Title)
                          Class="search-bar ml-8"
                          Margin=@Margin.Dense
                          AdornmentIcon=@Icons.Material.Filled.Search
                          Adornment=@Adornment.Start>
                <ItemTemplate Context="e">
                    <MudStack Row=true
                              Spacing=1
                              AlignItems=@AlignItems.Center>
                        @switch (e.Priority)
                        {
                            case Priority.Low:
                                <MudIcon Icon=@Icons.Material.Filled.KeyboardArrowDown
                                         Color=@Color.Success />
                                break;
                            case Priority.Medium:
                                <MudIcon Icon=@Icons.Material.Filled.Remove
                                         Color=@Color.Warning />    
                                break;
                            case Priority.High:
                                <MudIcon Icon=@Icons.Material.Filled.KeyboardArrowUp
                                         Color=@Color.Error />
                                break;
                        }
                        <MudText>@e.Title</MudText>

                        <MudSpacer/>

                        <MudIcon Icon=@Icons.Material.Filled.AccountCircle/>
                    </MudStack>
                </ItemTemplate>          
            </MudAutocomplete>
        </MiddleContent>

        <RightContent>
            <div class="d-flex align-center pr-1">
                @for (int i = 0; i < _visibleHeaderMembers.Count; i++)
                {
                    var member = _visibleHeaderMembers[i];
                    var isLast = i == _visibleHeaderMembers.Count - 1;

                    <div style="@(isLast ? "" : "margin-right: -12px;")">
                        <MudAvatar Class="cursor-pointer"
                                   Style="border: 2px solid var(--mud-palette-background);"
                                   @onmouseenter=@(() => _hoveredMemberId = member.Id)
                                   @onmouseleave=@(() => _hoveredMemberId = null)>
                            <MudIcon Icon=@Icons.Material.Filled.AccountCircle />
                        </MudAvatar>

                        <MudPopover Open=@(_hoveredMemberId == member.Id)
                                    Style="min-height: 50px; min-width: 100px"
                                    Elevation=1
                                    AnchorOrigin=@Origin.BottomLeft
                                    Class="pa-2">
                            <MudStack Row=true
                                      Spacing=1
                                      AlignItems=@AlignItems.Center>
                                <MudIcon Icon=@Icons.Material.Filled.AccountCircle
                                         Size=@Size.Large />
                                <MudStack Spacing=1>
                                    <MudText>@member.DisplayName</MudText>
                                    <MudText Typo=@Typo.caption>@($"@{member.Tag}")</MudText>
                                    <MudText Typo=@Typo.caption>@($"Joined at: {@member.JoinedAt.ToShortDateString()}")</MudText>
                                </MudStack>
                            </MudStack>
                        </MudPopover>
                    </div>
                }

                @if (_hiddenHeaderMembersCount > 0)
                {
                    <MudAvatar Class="cursor-pointer"
                               Style="border: 2px solid var(--mud-palette-background); margin-left: -12px;"
                               @onclick=@OnShowAllMembersClicked>
                        +@_hiddenHeaderMembersCount
                    </MudAvatar>
                }
            </div>

            @if (_currentUserRole >= BoardRole.Member)
            {
                @if (_isReorderingColumns == false)
                {
                    <MudMenu Icon=@Icons.Material.Filled.MoreVert
                             Color=@Color.Inherit
                             AnchorOrigin=@Origin.BottomCenter
                             TransformOrigin=@Origin.TopCenter>
                        <MudMenuItem Icon=@Icons.Material.Filled.SwapHoriz
                                     OnClick=@ToggleReorderMode>
                            Reorder columns
                        </MudMenuItem>
                        <MudMenuItem Icon=@Icons.Material.Filled.Settings
                                     Onclick=@OnBoardSettingsClicked>
                            Board settings
                        </MudMenuItem>
                    </MudMenu>
                }
                else
                {
                    <MudTooltip Text="Done reordering">
                        <MudIconButton Icon=@Icons.Material.Filled.Check
                                       Color=@Color.Inherit
                                       OnClick=@ToggleReorderMode />
                    </MudTooltip>
                }
            }

        </RightContent>
    </Header>

    <div style="margin-top: var(--mud-appbar-height); min-height: calc(100vh - var(--mud-appbar-height)); overflow-x: auto; width: 100%;">
        <div class="px-8 py-8 d-inline-flex align-start"
             style="@($"background-color: {_backgroundColor}; min-height: calc(100vh - var(--mud-appbar-height)); min-width: 100%; box-sizing: border-box;")">

            @if (_isReorderingColumns)
            {
                <MudDropContainer T=@ColumnModel
                                  Items=@_columns
                                  ItemsSelector=@((item, dropzone) => true)
                                  ItemDropped=@OnColumnDropped
                                  Class="d-flex flex-nowrap gap-4"
                                  @ref=@_columnDropContainer>
                    <ChildContent>
                        <MudDropZone T=@ColumnModel
                                     Identifier="board-zone"
                                     Class="d-flex flex-nowrap gap-4"
                                     Style="min-height: 100px;"
                                     AllowReorder=true />
                    </ChildContent>
                    <ItemRenderer Context="column">
                        <MudPaper Class="d-flex flex-column flex-shrink-0 pt-2 cursor-move shake-on-hover"
                                  MinHeight="75px"
                                  Width="325px"
                                  Elevation=4
                                  Style="border: 2px dashed var(--mud-palette-primary);">

                            <MudContainer Class="px-4 py-4 d-flex align-center">
                                <MudIcon Icon=@Icons.Material.Filled.DragIndicator
                                         Class="mr-2" />
                                <MudText Typo=@Typo.h6>
                                    @column.Title
                                </MudText>
                            </MudContainer>

                            <MudContainer Class="px-4 pb-4">
                                <MudText Typo=@Typo.body2
                                         Color=@Color.Secondary
                                         Align=@Align.Center>
                                    Tasks are hidden while reordering
                                </MudText>
                            </MudContainer>
                        </MudPaper>
                    </ItemRenderer>
                </MudDropContainer>
            }
            else
            {
                <MudDropContainer T=@TaskSummaryModel
                                  Items=@_allTasks
                                  Class="d-flex flex-nowrap gap-4"
                                  @ref=@_taskDropContainer
                                  ItemsSelector=@((item,dropzone) => item.ColumnId.ToString() == dropzone)
                                  ItemDropped=@TaskDropped>
                    <ChildContent>
                        @foreach (var column in _columns)
                        {
                            <div class="d-flex flex-column flex-shrink-0" style="width: 325px;">
                                <MudPaper Class="d-flex flex-column mud-width-full pt-2"
                                          MinHeight="75px"
                                          Width="325px">

                                    <MudContainer Class="px-4 py-1 d-flex flex-shrink-0">
                                        @if (column.IsEditing)
                                        {
                                            <MudTextField @bind-Value=@column.Title
                                                          Immediate=true
                                                          Variant=@Variant.Text
                                                          FullWidth=true
                                                          AutoFocus=true
                                                          MaxLength=50
                                                          Placeholder="Enter column title"
                                                          Style="font-size: 1.2rem"
                                                          @onkeydown=@((e) => HandleEditColumnEnter(e, column))>
                                            </MudTextField>

                                            <MudIconButton Class="pa-2 flex-shrink-0"
                                                           Icon=@Icons.Material.Filled.Close
                                                           Color=@Color.Error
                                                           @onclick=@(() => EditColumnClose(column))>
                                            </MudIconButton>
                                        }
                                        else
                                        {
                                            <MudText Typo=@Typo.h6
                                                     Class="flex-grow-1"
                                                     Style="word-break: break-word">
                                                @column.Title
                                            </MudText>

                                            @if (_currentUserRole >= BoardRole.Member)
                                            {
                                                <MudMenu Icon=@Icons.Material.Filled.MoreVert
                                                         Color=@Color.Primary
                                                         Size=@Size.Small
                                                         AnchorOrigin=@Origin.BottomCenter
                                                         TransformOrigin=@Origin.TopLeft>
                                                    <MudMenuItem Icon=@Icons.Material.Filled.Edit
                                                                 Class="px-2 py-1"
                                                                 Style="white-space: nowrap;"
                                                                 OnClick=@(() => OnEditColumnClick(column))>
                                                        Change title
                                                    </MudMenuItem>
                                                    <MudMenuItem IconColor=@Color.Error
                                                                 Icon=@Icons.Material.Filled.Delete
                                                                 Style="color: var(--mud-palette-error)"
                                                                 Class="px-2 py-1"
                                                                 OnClick=@(() => OnDeleteColumnClick(column))>
                                                        Delete
                                                    </MudMenuItem>
                                                </MudMenu>
                                            }
                                        }
                                    </MudContainer>

                                    <MudContainer Class="d-flex flex-column flex-grow-1 flex-shrink-1 pb-4 px-2">
                                        <MudDropZone T=TaskSummaryModel
                                                     Identifier=@column.Id.ToString()
                                                     Class="flex-grow-1"
                                                     AllowReorder="true"
                                                     Style="min-height: 10px;" />

                                        @if (column.IsAddTaskOpen)
                                        {
                                            <div class="flex-shrink-0">
                                                <MudPaper Class="task d-flex flex-column my-1 mud-theme-secondary cursor-pointer overflow-hidden"
                                                          Elevation=1>
                                                    <div class="d-flex align-center py-1">
                                                        <MudTextField @bind-Value=@column.NewTaskTitle
                                                                      Immediate=true
                                                                      Variant=@Variant.Filled
                                                                      Class="task-add-field flex-grow-1"
                                                                      Style="word-break: break-word;"
                                                                      Lines=2
                                                                      MaxLength=200
                                                                      AutoFocus=true
                                                                      Placeholder="Enter a title"
                                                                      AutoGrow=true
                                                                      Margin=@Margin.None
                                                                      OnKeyDown=@(e => HandleAddTaskEnter(e, column))>
                                                        </MudTextField>

                                                        <MudIconButton Class="pa-2 flex-shrink-0"
                                                                       Icon=@Icons.Material.Filled.Check
                                                                       @onclick=@(() => AddNewTask(column))>
                                                        </MudIconButton>

                                                        <MudIconButton Class="pa-2 pr-3 flex-shrink-0"
                                                                       Icon=@Icons.Material.Filled.Close
                                                                       Color=@Color.Error
                                                                       @onclick=@(() => AddTaskClose(column))>
                                                        </MudIconButton>
                                                    </div>
                                                </MudPaper>
                                            </div>
                                        }
                                    </MudContainer>

                                    @if (_currentUserRole >= BoardRole.Member)
                                    {
                                        <MudButton Class="pa-4 justify-start flex-shrink-0"
                                                   FullWidth=true
                                                   @onclick=@(() => OnAddTaskClicked(column))>
                                            <MudIcon Icon=@Icons.Material.Filled.Add Class="mr-2" />
                                            <MudText>Add a task</MudText>
                                        </MudButton>
                                    }
                                </MudPaper>
                            </div>
                        }

                        @if (_currentUserRole >= BoardRole.Member)
                        {
                            @if (_isAddColumnOpen)
                            {
                                <div class="d-flex flex-column flex-shrink-0" style="width: 375px;">
                                    <MudPaper Class="d-flex flex-column justify-center mud-width-full"
                                              MinHeight="100px"
                                              MinWidth="375px">

                                        <MudTextField @bind-Value=@_addColumnTitle
                                                      Immediate=true
                                                      Variant=@Variant.Outlined
                                                      FullWidth=true
                                                      Class="px-4 pt-4"
                                                      AutoFocus=true
                                                      MaxLength=50
                                                      Placeholder="Enter column title"
                                                      @onkeydown=@((e) => HandleAddColumnEnter(e))>
                                        </MudTextField>

                                        <MudStack Row=true Class="align-self-end px-2 py-1">
                                            <MudIconButton Class="pa-2"
                                                           Icon=@Icons.Material.Filled.Check
                                                           @onclick=@(() => AddNewColumn())>
                                            </MudIconButton>

                                            <MudIconButton Class="pa-2"
                                                           Icon=@Icons.Material.Filled.Close
                                                           Color=@Color.Error
                                                           @onclick=@(() => AddNewColumnClose())>
                                            </MudIconButton>
                                        </MudStack>
                                    </MudPaper>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex flex-column flex-shrink-0" style="width: 375px;">
                                    <MudPaper Class="d-flex align-center justify-center mud-width-full cursor-pointer mr-4"
                                              Height="525px"
                                              Width="375px"
                                              Style="border: 2px dashed white; background-color: transparent;"
                                              @onclick=OnAddColumnClicked>
                                        <MudStack AlignItems=@AlignItems.Center
                                                  Spacing=2>

                                            <MudIcon Icon=@Icons.Material.Filled.Add
                                                     Size=@Size.Large
                                                     Style="color: white" />

                                            <MudText Typo=@Typo.h6
                                                     Style="color: white">
                                                Add a column
                                            </MudText>
                                        </MudStack>
                                    </MudPaper>
                                </div>
                            }
                        }
                    </ChildContent>
                    <ItemRenderer Context="task">
                        <div>
                            <MudPaper Class="task d-flex flex-column my-1 mud-theme-secondary cursor-pointer overflow-hidden"
                                      Elevation=1
                                      Style="min-height: 70px"
                                      @onclick=@(() => OnTaskClicked(task.Id))>
                                <div style="height: 4px; width: 100%; background-color: @GetColorForPriority(task.Priority);"></div>

                                <div class="d-flex pl-3 pr-1 flex-grow-1 align-center py-2">
                                    <MudText Class="flex-grow-1"
                                             Style=@((task.IsComplete ? "text-decoration: line-through;" : "") + " word-break: break-word; white-space: pre-wrap;")>
                                        @task.Title
                                    </MudText>

                                    <MudTooltip Text="@(_currentUserRole == BoardRole.Visitor ? "Visitors cannot change task status" : null)"
                                                Placement=@Placement.Bottom
                                                Arrow=true>
                                        <MudCheckBox T=bool
                                                     Disabled=@(_currentUserRole == BoardRole.Visitor)
                                                     ValueChanged=@(() => OnCheckedChange(task))
                                                     Value=@task.IsComplete
                                                     Dense=true
                                                     Class="flex-shrink-0 pl-1" />
                                    </MudTooltip>
                                </div>
                            </MudPaper>
                        </div>
                    </ItemRenderer>

                </MudDropContainer>
            }
        </div>
    </div>
</AuthGuard>