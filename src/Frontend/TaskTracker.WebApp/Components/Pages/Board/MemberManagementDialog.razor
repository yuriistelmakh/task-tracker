@using TaskTracker.Domain.Enums
@using TaskTracker.WebApp.Models
<MudDialog TitleClass="pa-0"
           ContentClass="pa-4">
    <DialogContent>

        <MudStack Row=true>
            <MudText Typo=@Typo.h6>
                <bold>Manage members</bold>
            </MudText>

            <MudSpacer />

            <MudIconButton Icon=@Icons.Material.Filled.Close
                           @onclick="OnCloseClicked" />
        </MudStack>

        <MudTabs Elevation=0
                 Rounded=true
                 ApplyEffectsToContainer=true
                 SliderAnimation=true>
            <MudTabPanel Text=@($"Members ({_membersCount})")
                         Style="text-transform: none !important;"
                         Class="py-4">
                <MudInput T=string
                          Adornment=@Adornment.Start
                          AdornmentIcon=@Icons.Material.Filled.Search
                          Variant=@Variant.Outlined
                          Margin=@Margin.Dense
                          Style="width: 100%"
                          Placeholder="Search members..." />

                <MudStack Class="pt-2">
                    @foreach (var member in _members)
                    {
                        <MudPaper Class="pa-2"
                                  Elevation=0
                                  Style="border: 1px solid var(--mud-palette-secondary)">

                            <MudGrid Spacing=2>

                                <MudItem xs=8>
                                    <MudStack Row=true
                                              AlignItems=@AlignItems.Center>
                                        <MudIcon Icon=@Icons.Material.Filled.AccountCircle
                                                 Size=@Size.Large />
                                        <MudStack Spacing=0>
                                            <MudStack Row=true
                                                      Spacing=1
                                                      AlignItems=@AlignItems.Center>
                                                <MudText>@member.DisplayName</MudText>
                                                @if (member.Role == BoardRole.Owner)
                                                {
                                                    <MudTooltip Text="Owner"
                                                                Inline=true
                                                                Arrow=true
                                                                Placement=@Placement.Top>
                                                        <MudIcon Icon=@Icons.Material.Filled.Star
                                                                 Size=@Size.Small />
                                                    </MudTooltip>
                                                }
                                            </MudStack>
                                            <MudText Typo=@Typo.subtitle2 Color=@Color.Primary>@($"@{member.Tag}")</MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs=4>
                                    @if (_currentUserRole > BoardRole.Member)
                                    {
                                        <MudSelect T=@BoardRole
                                                   Margin=@Margin.Dense
                                                   Variant=@Variant.Outlined
                                                   FullWidth=true
                                                   Value=@member.Role
                                                   ValueChanged=@((BoardRole newRole) => OnRoleChange(member, newRole))
                                                   Disabled=@(member.Role == BoardRole.Owner && member.Id != _currentUserId)>
                                            @if (_currentUserRole == BoardRole.Owner)
                                            {
                                                <MudSelectItem Value=@BoardRole.Owner>
                                                    <MudText>Owner</MudText>
                                                    <MudText Typo=@Typo.caption
                                                             Style="line-height: 5px !important">
                                                        Has full control over the board including its deletion
                                                    </MudText>
                                                </MudSelectItem>
                                            }

                                            <MudSelectItem Value=@BoardRole.Admin>
                                                <MudText>Administrator</MudText>
                                                <MudText Typo=@Typo.caption>
                                                    Can manage board settings and members
                                                </MudText>
                                            </MudSelectItem>

                                            <MudSelectItem Value=@BoardRole.Member>
                                                <MudText>Member</MudText>
                                                <MudText Typo=@Typo.caption>
                                                    Can create, edit and move tasks
                                                </MudText>
                                            </MudSelectItem>

                                            <MudSelectItem Value=@BoardRole.Visitor>
                                                <MudText>Visitor</MudText>
                                                <MudText Typo=@Typo.caption>
                                                    Can only view the board
                                                </MudText>
                                            </MudSelectItem>
                                        </MudSelect>
                                    }
                                    else
                                    {
                                        <MudContainer Class="d-flex justify-end align-center pa-0 pr-2"
                                                      Style="height: 100%">
                                            <MudText>@member.Role</MudText>
                                        </MudContainer>
                                    }
                                </MudItem>

                            </MudGrid>
                        </MudPaper>
                    }
                    <MudContainer Class="d-flex justify-end pa-0">
                        <MudButton Variant=@Variant.Filled
                                   Color=@Color.Primary
                                   @onclick=@OnCloseClicked>
                              Done 
                        </MudButton>
                    </MudContainer>
                </MudStack>
            </MudTabPanel>

            @if (_currentUserRole >= BoardRole.Admin)
            {
                <MudTabPanel Text="Invite members"
                             Style="text-transform: none !important;">
                    <MudText Class="pt-2">
                        <b>Invite people by their name or tag</b>
                    </MudText>

                    <MudAutocomplete T=@UserSummaryModel
                                     Value=@_invitationUserSearch
                                     ValueChanged=@OnUserSelected
                                     DebounceInterval=500
                                     SearchFunc=@PerformSearch
                                     FullWidth=true
                                     Variant=@Variant.Outlined
                                     Margin=@Margin.Dense
                                     Adornment=@Adornment.None
                                     ToStringFunc=@(p => p is null ? null : p.DisplayName)
                                     Class="mt-2"
                                     Placeholder="Type to search...">

                        <ItemTemplate Context="e">
                            <MudStack Row=true
                                      AlignItems=@AlignItems.Center
                                      Spacing=2>
                                <MudIcon Icon=@Icons.Material.Filled.AccountCircle />
                                <MudStack Spacing=0>
                                    <MudText>@e.DisplayName</MudText>
                                    <MudText Typo=@Typo.caption>@($"@{e.Tag}")</MudText>
                                </MudStack>
                            </MudStack>
                        </ItemTemplate>
                    </MudAutocomplete>

                    @if (_usersToInvite.Any())
                    {
                        <MudStack Class="py-2" Spacing=2>
                            @foreach (var user in _usersToInvite)
                            {
                                <MudPaper Class="pa-2"
                                          Elevation=0
                                          Style="border: 1px solid var(--mud-palette-secondary)">
                                    <MudStack Row=true
                                              AlignItems=@AlignItems.Center
                                              Justify=@Justify.SpaceBetween>

                                        <MudStack Row=true
                                                  AlignItems=@AlignItems.Center
                                                  Spacing=2>
                                            <MudIcon Icon=@Icons.Material.Filled.AccountCircle
                                                     Size=@Size.Large />
                                            <MudStack Spacing=0>
                                                <MudText>@user.DisplayName</MudText>
                                                <MudText Typo=@Typo.caption
                                                         Color=@Color.Primary>@($"@{user.Tag}")</MudText>
                                            </MudStack>
                                        </MudStack>

                                        <MudIconButton Icon=@Icons.Material.Filled.Close
                                                       Color=@Color.Error
                                                       OnClick=@(() => RemoveUserFromInvite(user)) />
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    }

                    <MudText Class="pt-4">
                        <b>Role</b>
                    </MudText>

                    <MudCard Elevation=0
                             Style=@($"border: 1px solid {(_inviteRole == BoardRole.Admin ? "var(--mud-palette-primary)" : "var(--mud-palette-divider)")}; cursor: pointer")
                             Class="my-2"
                             @onclick=@(() => _inviteRole = BoardRole.Admin)>
                        <MudStack Row=true
                                  AlignItems=@AlignItems.Center
                                  Class="pa-2">
                            <MudIcon Icon=@Icons.Material.Filled.Engineering
                                     Color=@(_inviteRole == BoardRole.Admin ? Color.Primary : Color.Default)
                                     Size=@Size.Large />
                            <MudStack Spacing=0>
                                <MudText Color=@(_inviteRole == BoardRole.Admin ? Color.Primary : Color.Default)>
                                    <b>Administrator</b>
                                </MudText>
                                <MudText Typo=@Typo.caption>
                                    Can manage board settings and members
                                </MudText>
                            </MudStack>
                        </MudStack>
                    </MudCard>

                    <MudCard Elevation=0
                             Style=@($"border: 1px solid {(_inviteRole == BoardRole.Member ? "var(--mud-palette-primary)" : "var(--mud-palette-divider)")}; cursor: pointer")
                             Class="my-2"
                             @onclick=@(() => _inviteRole = BoardRole.Member)>
                        <MudStack Row=true
                                  AlignItems=@AlignItems.Center
                                  Class="pa-2">
                            <MudIcon Icon=@Icons.Material.Filled.Person
                                     Color=@(_inviteRole == BoardRole.Member ? Color.Primary : Color.Default)
                                     Size=@Size.Large />
                            <MudStack Spacing=0>
                                <MudText Color=@(_inviteRole == BoardRole.Member ? Color.Primary : Color.Default)>
                                    <b>Member</b>
                                </MudText>
                                <MudText Typo=@Typo.caption>
                                    Can edit the board
                                </MudText>
                            </MudStack>
                        </MudStack>
                    </MudCard>

                    <MudCard Elevation=0
                             Style=@($"border: 1px solid {(_inviteRole == BoardRole.Visitor ? "var(--mud-palette-primary)" : "var(--mud-palette-divider)")}; cursor: pointer")
                             Class="my-2"
                             @onclick=@(() => _inviteRole = BoardRole.Visitor)>
                        <MudStack Row=true
                                  AlignItems=@AlignItems.Center
                                  Class="pa-2">
                            <MudIcon Icon=@Icons.Material.Filled.Visibility
                                     Color=@(_inviteRole == BoardRole.Visitor ? Color.Primary : Color.Default)
                                     Size=@Size.Large />
                            <MudStack Spacing=0>
                                <MudText Color=@(_inviteRole == BoardRole.Visitor ? Color.Primary : Color.Default)>
                                    <b>Viewer</b>
                                </MudText>
                                <MudText Typo=@Typo.caption>
                                    Can only view the board
                                </MudText>
                            </MudStack>
                        </MudStack>
                    </MudCard>

                    <MudButton FullWidth=true
                               Variant=@Variant.Filled
                               Color=@Color.Primary
                               OnClick=@SendInvitations
                               Disabled=@(!_usersToInvite.Any())
                               Class="mb-2">
                        <MudIcon Icon=@Icons.Material.Filled.PersonAdd
                                 Class="mr-1" />
                        Send invitation@(_usersToInvite.Count > 1 ? "s" : "")
                    </MudButton>
                </MudTabPanel>
            }
        </MudTabs>
    </DialogContent>
</MudDialog>